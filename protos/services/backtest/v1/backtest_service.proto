syntax = "proto3";

package backtest;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// Backtest Service - gRPC API
// Used by GenAI Service for executing backtests and retrieving results

service BacktestService {
  // Execute backtest for a strategy
  rpc ExecuteBacktest(ExecuteBacktestRequest) returns (ExecuteBacktestResponse);

  // Get backtest result by ID
  rpc GetBacktestResult(GetBacktestResultRequest) returns (BacktestResultResponse);

  // Stream backtest progress updates
  rpc StreamBacktestProgress(StreamProgressRequest) returns (stream ProgressUpdate);

  // Get backtest metrics
  rpc GetBacktestMetrics(GetMetricsRequest) returns (MetricsResponse);

  // List backtests for a user
  rpc ListBacktests(ListBacktestsRequest) returns (ListBacktestsResponse);

  // Cancel a running backtest
  rpc CancelBacktest(CancelBacktestRequest) returns (CancelBacktestResponse);

  // Health check
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

// ============================================================================
// Request Messages
// ============================================================================

message ExecuteBacktestRequest {
  string user_id = 1; // User ID for authorization
  string strategy_id = 2; // Strategy ID to backtest
  optional int32 strategy_version_seq = 3; // Optional: specific version (default: latest)
  BacktestConfig config = 4; // Backtest configuration
}

message BacktestConfig {
  string symbol = 1; // Trading symbol (e.g., "BTCUSDT")
  string interval = 2; // Time interval (e.g., "1d", "1h", "5m")
  string start_date = 3; // Start date (ISO 8601 format: "2024-01-01")
  string end_date = 4; // End date (ISO 8601 format: "2024-12-31")
  double initial_capital = 5; // Initial capital amount

  // Slippage & Commission
  optional double slippage_bps = 6; // Slippage in basis points (default from config)
  optional double commission_per_trade = 7; // Commission per trade (default from config)

  // Risk Management
  optional double stop_loss_pct = 8; // Stop loss percentage
  optional double take_profit_pct = 9; // Take profit percentage
  optional double max_position_size = 10; // Max position size as % of equity

  // Additional parameters
  map<string, string> params = 11; // Additional strategy parameters

  // Snapshot settings
  optional int32 snapshot_interval_seconds = 12; // Portfolio snapshot interval
}

message GetBacktestResultRequest {
  string backtest_id = 1; // Backtest job ID
  string user_id = 2; // User ID for authorization
}

message StreamProgressRequest {
  string backtest_id = 1; // Backtest job ID
  string user_id = 2; // User ID for authorization
}

message GetMetricsRequest {
  string backtest_id = 1; // Backtest job ID
  string user_id = 2; // User ID for authorization
}

message ListBacktestsRequest {
  string user_id = 1; // User ID for authorization
  optional string strategy_id = 2; // Optional: filter by strategy
  optional string status = 3; // Optional: filter by status (pending, running, completed, failed)
  optional int32 limit = 4; // Optional: max results (default: 50)
  optional int32 skip = 5; // Optional: skip N results (pagination)
}

message CancelBacktestRequest {
  string backtest_id = 1; // Backtest job ID
  string user_id = 2; // User ID for authorization
}

message HealthCheckRequest {
  // Empty for now - can add service version, timestamp, etc.
}

// ============================================================================
// Response Messages
// ============================================================================

message ExecuteBacktestResponse {
  string backtest_id = 1; // Created backtest job ID
  string status = 2; // Job status: "pending", "queued", "running"
  string message = 3; // Status message
  google.protobuf.Timestamp created_at = 4; // Job creation timestamp
}

message BacktestResultResponse {
  string backtest_id = 1; // Backtest job ID
  string strategy_id = 2; // Strategy ID
  optional int32 strategy_version_seq = 3; // Strategy version sequence
  string status = 4; // Job status: "completed", "failed", "running", etc.

  // Results (only available when status = "completed")
  optional PerformanceMetrics metrics = 5; // Performance metrics
  repeated Trade trades = 6; // Trade history
  repeated EquityPoint equity_curve = 7; // Equity curve data

  // Metadata
  BacktestConfig config = 8; // Original backtest configuration
  google.protobuf.Timestamp created_at = 9; // Job creation time
  optional google.protobuf.Timestamp completed_at = 10; // Job completion time
  optional string error_message = 11; // Error message (if failed)
}

message ProgressUpdate {
  string backtest_id = 1; // Backtest job ID
  string status = 2; // Current status
  double progress_pct = 3; // Progress percentage (0-100)
  string message = 4; // Progress message
  google.protobuf.Timestamp timestamp = 5; // Update timestamp

  // Optional: current metrics snapshot
  optional PerformanceMetrics current_metrics = 6;
}

message MetricsResponse {
  string backtest_id = 1; // Backtest job ID
  PerformanceMetrics metrics = 2; // Performance metrics
  google.protobuf.Timestamp calculated_at = 3; // Calculation timestamp
}

message ListBacktestsResponse {
  repeated BacktestSummary backtests = 1; // List of backtest summaries
  int32 total_count = 2; // Total number of backtests (for pagination)
}

message BacktestSummary {
  string backtest_id = 1; // Backtest job ID
  string strategy_id = 2; // Strategy ID
  optional int32 strategy_version_seq = 3; // Strategy version
  string status = 4; // Job status
  string symbol = 5; // Trading symbol
  string interval = 6; // Time interval
  google.protobuf.Timestamp created_at = 7; // Creation time
  optional google.protobuf.Timestamp completed_at = 8; // Completion time
  optional PerformanceMetrics metrics = 9; // Metrics (if completed)
}

message CancelBacktestResponse {
  string backtest_id = 1; // Backtest job ID
  string status = 2; // New status (should be "cancelled")
  string message = 3; // Cancellation message
}

message HealthCheckResponse {
  string status = 1; // "healthy" or "unhealthy"
  string service_name = 2; // "backtest-service"
  string version = 3; // Service version
  google.protobuf.Timestamp timestamp = 4; // Response timestamp
  map<string, string> details = 5; // Additional health details
}

// ============================================================================
// Data Models
// ============================================================================

message PerformanceMetrics {
  // Returns
  double total_return = 1; // Total return (%)
  double annual_return = 2; // Annualized return (%)

  // Risk metrics
  double sharpe_ratio = 3; // Sharpe ratio
  double sortino_ratio = 4; // Sortino ratio
  double max_drawdown = 5; // Maximum drawdown (%)
  double volatility = 6; // Volatility (annualized)

  // Trade statistics
  int32 total_trades = 7; // Total number of trades
  int32 winning_trades = 8; // Number of winning trades
  int32 losing_trades = 9; // Number of losing trades
  double win_rate = 10; // Win rate (%)

  // Profit metrics
  double profit_factor = 11; // Profit factor (gross profit / gross loss)
  double average_win = 12; // Average winning trade amount
  double average_loss = 13; // Average losing trade amount
  double largest_win = 14; // Largest winning trade
  double largest_loss = 15; // Largest losing trade

  // Exposure
  double average_holding_period_hours = 16; // Average holding period in hours
  double max_consecutive_wins = 17; // Max consecutive winning trades
  double max_consecutive_losses = 18; // Max consecutive losing trades

  // Final values
  double final_equity = 19; // Final portfolio equity
  double total_fees = 20; // Total fees/commissions paid
}

message Trade {
  google.protobuf.Timestamp timestamp = 1; // Trade execution time
  string symbol = 2; // Trading symbol
  string side = 3; // "BUY" or "SELL"
  double quantity = 4; // Quantity traded
  double price = 5; // Execution price
  double pnl = 6; // Profit/Loss for this trade (for SELL only)
  double commission = 7; // Commission paid
  optional string trade_id = 8; // Internal trade ID
  optional double portfolio_value = 9; // Portfolio value after trade
}

message EquityPoint {
  google.protobuf.Timestamp timestamp = 1; // Data point timestamp
  double equity = 2; // Portfolio equity at this time
  double drawdown = 3; // Drawdown percentage at this time
  double cash = 4; // Cash balance
  double positions_value = 5; // Total value of open positions
}

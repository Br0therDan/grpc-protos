syntax = "proto3";

package genai.chatops;

import "google/protobuf/struct.proto";
import "protos/common/metadata.proto";
import "protos/common/pagination.proto";

// ChatOps 서비스
service ChatOpsService {
  // 세션 생성
  rpc CreateSession(CreateSessionRequest) returns (CreateSessionResponse);

  // 양방향 스트리밍 대화
  rpc ChatStream(stream ChatMessage) returns (stream ChatResponse);

  // 세션 히스토리 조회
  rpc GetSessionHistory(GetSessionHistoryRequest) returns (GetSessionHistoryResponse);

  // 세션 종료
  rpc CloseSession(CloseSessionRequest) returns (CloseSessionResponse);
}

// 세션 생성 요청
message CreateSessionRequest {
  string user_id = 1; // 사용자 ID
  SessionContext context = 2; // 세션 컨텍스트
  common.Metadata metadata = 3; // 요청 메타데이터
}

// 세션 컨텍스트
message SessionContext {
  string domain = 1; // 도메인 (예: "strategy", "analysis")
  string entity_id = 2; // 관련 엔티티 ID (선택)
  map<string, string> custom_context = 3; // 커스텀 컨텍스트
}

// 세션 생성 응답
message CreateSessionResponse {
  string session_id = 1; // 세션 ID
  int64 created_at = 2; // 생성 시간 (Unix timestamp)
}

// 대화 메시지 (클라이언트 → 서버)
message ChatMessage {
  string session_id = 1; // 세션 ID
  string message = 2; // 사용자 메시지
  map<string, string> metadata = 3; // 메타데이터 (선택)
}

// 대화 응답 (서버 → 클라이언트)
message ChatResponse {
  string session_id = 1; // 세션 ID
  string response = 2; // AI 응답 (Markdown)
  ResponseType response_type = 3; // 응답 타입
  repeated ToolUsage tools_used = 4; // 사용된 도구
  int32 tokens_used = 5; // 사용 토큰 수
  int64 timestamp = 6; // 응답 시간 (Unix timestamp)
}

// 응답 타입
enum ResponseType {
  RESPONSE_TYPE_UNSPECIFIED = 0;
  RESPONSE_TYPE_TEXT = 1; // 일반 텍스트
  RESPONSE_TYPE_STRATEGY_RECOMMENDATION = 2; // 전략 추천
  RESPONSE_TYPE_ANALYSIS = 3; // 분석 결과
  RESPONSE_TYPE_ERROR = 4; // 에러 메시지
}

// 도구 사용 정보
message ToolUsage {
  string tool_name = 1; // 도구 이름 (예: "MarketDataTool")
  google.protobuf.Struct input = 2; // 도구 입력
  google.protobuf.Struct output = 3; // 도구 출력
  int64 execution_time_ms = 4; // 실행 시간 (밀리초)
}

// 세션 히스토리 조회 요청
message GetSessionHistoryRequest {
  string session_id = 1; // 세션 ID
  common.PaginationRequest pagination = 2; // 페이지네이션
  common.Metadata metadata = 3; // 요청 메타데이터
}

// 세션 히스토리 조회 응답
message GetSessionHistoryResponse {
  repeated HistoryEntry entries = 1; // 히스토리 항목
  common.PaginationResponse pagination = 2; // 페이지네이션 정보
}

// 히스토리 항목
message HistoryEntry {
  string role = 1; // 역할 ("user", "assistant", "system")
  string content = 2; // 내용
  int64 timestamp = 3; // 시간 (Unix timestamp)
  int32 tokens = 4; // 토큰 수
}

// 세션 종료 요청
message CloseSessionRequest {
  string session_id = 1; // 세션 ID
  common.Metadata metadata = 2; // 요청 메타데이터
}

// 세션 종료 응답
message CloseSessionResponse {
  bool success = 1; // 성공 여부
  int32 total_tokens_used = 2; // 총 사용 토큰 수
  int32 total_messages = 3; // 총 메시지 수
}
